# 业务逻辑与功能模块

## 用户认证与授权

### 用户注册流程
1. **注册方式支持**
   - 账号注册
   - 邮箱注册  
   - 手机号注册

2. **注册验证**
   - 检查账号/邮箱/手机号唯一性
   - 密码强度验证（由前端处理）
   - 用户名长度和格式验证

3. **密码安全**
   - 使用bcrypt进行密码哈希（salt rounds: 10）
   - 密码不存储明文
   - 支持密码重置（待实现）

### 用户登录流程
1. **登录方式**
   - 账号 + 密码
   - 邮箱 + 密码
   - 手机号 + 密码

2. **登录验证**
   - 根据登录类型查找用户
   - bcrypt密码比对
   - 生成JWT token
   - 返回用户信息（不含密码）

3. **JWT Token管理**
   - Token有效期配置
   - 自动刷新机制（待实现）
   - Token存储在前端localStorage

### 权限控制
1. **用户角色**
   - `user`: 普通用户
   - `admin`: 管理员

2. **路由保护**
   - `UserGuard`: 保护用户端路由
   - `AdminGuard`: 保护管理员路由
   - `ProtectedAdminRoute`: 管理员页面专用保护

3. **API权限验证**
   - JWT中间件验证token有效性
   - 基于用户角色的接口访问控制

## 情绪管理核心业务

### 情绪记录
1. **数据结构**
   ```typescript
   interface EmotionRecord {
     id: number;
     user_id: number;
     mood: string;           // 情绪类型
     intensity: number;      // 强度 (1-10)
     activities: string;     // 相关活动 (JSON字符串)
     description: string;    // 详细描述
     tags: string;          // 标签 (JSON字符串)
     created_at: string;    // 创建时间
     updated_at: string;    // 更新时间
   }
   ```

2. **记录流程**
   - 选择基础情绪类型
   - 设置情绪强度（1-10级）
   - 选择相关活动（多选）
   - 添加文字描述
   - 设置标签
   - 保存记录

3. **数据验证**
   - 强度范围校验 (1-10)
   - 必填字段验证
   - 数据类型校验
   - 防SQL注入处理

### 情绪历史查看
1. **查询功能**
   - 按日期范围筛选
   - 按情绪类型筛选
   - 按强度范围筛选
   - 按标签筛选
   - 关键词搜索

2. **显示方式**
   - 时间线视图
   - 日历视图
   - 列表视图
   - 统计图表视图

3. **操作功能**
   - 查看详情
   - 编辑记录
   - 删除记录
   - 导出数据

### 情绪分析
1. **数据统计**
   - 情绪分布统计
   - 强度变化趋势
   - 活动关联分析
   - 时间模式分析

2. **可视化展示**
   - 饼图：情绪类型分布
   - 折线图：情绪强度趋势
   - 柱状图：活动频次统计
   - 热力图：时间分布模式
   - 词云图：情绪描述词频

3. **洞察报告**
   - 情绪波动分析
   - 影响因素识别
   - 改善建议生成
   - 个人情绪模式总结

## 管理员功能

### 用户管理
1. **用户列表**
   - 分页查看所有用户
   - 用户信息搜索
   - 用户状态管理
   - 批量操作

2. **用户操作**
   - 查看用户详情
   - 编辑用户信息
   - 重置用户密码
   - 禁用/启用用户
   - 删除用户账户

3. **权限管理**
   - 角色分配
   - 权限设置
   - 访问控制

### 数据分析
1. **系统统计**
   - 用户数量统计
   - 活跃用户分析
   - 情绪记录总量
   - 使用频率分析

2. **趋势分析**
   - 用户增长趋势
   - 使用活跃度变化
   - 功能使用统计
   - 数据质量分析

3. **报表生成**
   - 定期数据报告
   - 自定义分析报表
   - 数据导出功能

### 系统设置
1. **基础配置**
   - 系统参数设置
   - 功能开关控制
   - 安全策略配置

2. **数据管理**
   - 数据备份
   - 数据清理
   - 数据迁移

## 数据流转

### 前端状态管理（Zustand）
1. **用户状态 (authStore)**
   - 用户登录状态
   - 用户信息缓存
   - Token管理

2. **管理员状态 (adminStore)**
   - 管理员登录状态
   - 管理数据缓存
   - 操作权限控制

### API数据流
1. **请求流程**
   ```
   前端组件 → API Service → HTTP请求 → Express路由 → 业务逻辑 → 数据库操作
   ```

2. **响应流程**
   ```
   数据库结果 → 业务逻辑处理 → HTTP响应 → API Service → 状态更新 → 组件重渲染
   ```

### 错误处理
1. **前端错误处理**
   - API请求错误捕获
   - 用户友好错误提示
   - 错误日志记录

2. **后端错误处理**
   - 全局错误中间件
   - 数据库操作异常处理
   - 请求参数验证

## 安全考虑

### 数据安全
- 密码哈希存储
- JWT Token安全传输
- SQL注入防护
- XSS攻击防护

### 权限安全
- 基于角色的访问控制
- API接口权限验证
- 敏感操作二次验证
- 操作日志记录

### 隐私保护
- 用户数据加密存储
- 数据访问审计
- 数据删除机制
- 隐私设置控制